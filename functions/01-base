#! /bin/bash
#set -eu

dir="$(dirname "$0")"

base="${dir}/packages/base.list"
toprc="${dir}/dotfiles/toprc"
function install_base {
  show_header "Installing base packages and their config files."
  check_installed $(cat ${base})
  check_fail
  show_success "Base packages installed."

  show_info "Installing toprc."
  cp -f ${toprc} ${HOME}/.toprc
  show_success "Installed toprc."
}

function enable_sudo_insults {
  # Customize sudo to insult incorrect password attempts
  show_info "Enabling sudo insults."
  sudo sh -c 'cat /etc/sudoers | \
              sed -e "/^Defaults\tsecure_path/a Defaults\tinsults" | \
              (EDITOR="tee" visudo >/dev/null)'
}

purge="${dir}/packages/purge.list"
function purge_packages {
  show_header "Purging unwanted packaged often installed by default." 
  check_uninstalled $(cat ${purge})
  check_fail
  show_success "Base packages installed."
}

function update_packages {
  show_header "Updating packages."
  sudo sh -c "apt-get update && \
    apt-get -y upgrade && \
    apt-get -y dist-upgrade && \
    apt-get -y autoremove && \
    apt-get -y autoclean && \
    update-grub"
  check_fail
  show_success "Packages updated."
}

function 01-base {
  show_question "Base: what do you want to install?"
  show_info "Main\n ${endbranch} Base (Hit ENTER to see options again.)"

  options=("Back" "Base packages" "Purge packages" "Updates" "Sudo insults")
  select option in "${options[@]}"; do
    case $option in
      "Back")
        break
        ;;
      "Base packages")
        install_base
        show_info "Main\n ${endbranch} Base (Hit ENTER to see options again.)"
        ;;
      "Purge packages")
        purge_packages
        show_info "Main\n ${endbranch} Base (Hit ENTER to see options again.)"
        ;;
      "Updates")
        update_packages
        show_info "Main\n ${endbranch} Base (Hit ENTER to see options again.)"
        ;;
      "Sudo insults")
        enable_sudo_insults
        show_info "Main\n ${endbranch} Base (Hit ENTER to see options again.)"
        ;;
      *)
        show_warning "Invalid option."
        show_info "Main\n ${endbranch} Base (Hit ENTER to see options again.)"
        ;;
    esac
  done
}
